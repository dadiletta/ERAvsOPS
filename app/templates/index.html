<script>
    // Pass team data from Flask to JavaScript
    window.teamData = {{ teams|tojson }};
    window.dataStatus = {{ status|tojson }};
    
    // MLB color theme
    const MLB_COLORS = {
        blue: "#002D72",
        red: "#E31937"
    };
    
    // Utility function to show toast notifications with MLB colors
    function showToast(message, type = "info") {
        console.log("Showing toast:", message, type);
        const bgColors = {
            success: `linear-gradient(to right, ${MLB_COLORS.blue}, #4682B4)`,
            error: `linear-gradient(to right, ${MLB_COLORS.red}, #FF6347)`,
            warning: "linear-gradient(to right, #f6d365, #fda085)",
            info: `linear-gradient(to right, ${MLB_COLORS.blue}, #4FC3F7)`,
            update: `linear-gradient(to right, ${MLB_COLORS.red}, ${MLB_COLORS.blue})`
        };
        
        // Check if Toastify is loaded
        if (typeof Toastify !== 'function') {
            console.error("Toastify is not loaded!");
            return;
        }
        
        Toastify({
            text: message,
            duration: 3000,
            close: true,
            gravity: "top",
            position: "right",
            style: {
                background: bgColors[type] || bgColors.info
            }
        }).showToast();
    }
    
    // Function to position quadrant labels
    function positionQuadrantLabels() {
        console.log("Positioning quadrant labels");
        const chart = document.getElementById('mlbChart');
        const container = chart.parentElement;
        const chartRect = chart.getBoundingClientRect();
        
        // Get chart dimensions
        const chartWidth = chartRect.width;
        const chartHeight = chartRect.height;
        
        // Position labels
        const labels = {
            'top-left': { x: 0.25, y: 0.25 },
            'top-right': { x: 0.75, y: 0.25 },
            'bottom-left': { x: 0.25, y: 0.75 },
            'bottom-right': { x: 0.75, y: 0.75 }
        };
        
        for (const [id, pos] of Object.entries(labels)) {
            const label = document.getElementById(id);
            if (label) {
                label.style.left = (chartWidth * pos.x) + 'px';
                label.style.top = (chartHeight * pos.y) + 'px';
            } else {
                console.error(`Label with id ${id} not found`);
            }
        }
    }
    
    // Function to check for updates
    function checkForUpdates() {
        fetch('/api/update-status')
            .then(response => response.json())
            .then(status => {
                // Only show update notifications if an update is in progress
                if (status.in_progress) {
                    const progressMessage = `Updating team data: ${status.teams_updated}/${status.total_teams}`;
                    showToast(progressMessage, "update");
                    
                    // If update is still in progress, check again in 2 seconds
                    setTimeout(checkForUpdates, 2000);
                } else if (status.last_updated && !window.lastUpdateChecked) {
                    // Update completed since we started checking
                    window.lastUpdateChecked = status.last_updated;
                    showToast("Data update complete! Refresh the page to see the latest data.", "success");
                }
            })
            .catch(error => {
                console.error("Error checking update status:", error);
            });
    }
    
    // Event listener for page load
    window.addEventListener('DOMContentLoaded', function() {
        console.log("DOM content loaded");
        
        // Display appropriate toast based on data status
        if (window.dataStatus.from_cache) {
            if (window.dataStatus.is_fresh) {
                showToast("Using fresh cached data", "success");
            } else {
                showToast("Using cached data - updating in background", "info");
            }
        }
        
        // Check for updates if they're in progress
        if (window.dataStatus.update_in_progress) {
            showToast("Starting data update...", "update");
            // Start checking for updates
            setTimeout(checkForUpdates, 1000);
        }
        
        // Add event listener to apply CSS classes to ensure proper logo sizing
        setTimeout(function() {
            // Find all image elements in the chart
            const chartImages = document.querySelectorAll('canvas + div img');
            console.log("Found chart images:", chartImages.length);
            chartImages.forEach(img => {
                img.classList.add('logo-image');
            });
            
            // Position the quadrant labels after chart is rendered
            positionQuadrantLabels();
        }, 1000);
    });
    
    // Reposition labels on window resize
    window.addEventListener('resize', positionQuadrantLabels);
</script>